<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Galaga Redux</title>
<style>
html,body{margin:0;background:black;color:white;font-family:Arial}
canvas{display:block;margin:auto}
button{
  padding:10px 20px;
  margin:6px;
  font-size:16px;
  border:none;
  cursor:pointer;
}
#menu,#shop{
  position:absolute;inset:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  background:linear-gradient(#000,#020824);
}
.hidden{display:none}
.levelBtn{width:240px}
</style>
</head>

<body>
<canvas id="c" width="720" height="900"></canvas>

<div id="menu">
  <h1>GALAGA REDUX</h1>
  <div id="levels"></div>
  <button onclick="openShop()">SHOP</button>
</div>

<div id="shop" class="hidden">
  <h2>SHIP SHOP</h2>
  <div id="ships"></div>
  <button onclick="closeShop()">BACK</button>
</div>

<script>
/* ================= CORE ================= */
const c = document.getElementById("c");
const x = c.getContext("2d");
let state="MENU", keys={}, raf;
document.onkeydown=e=>keys[e.key]=true;
document.onkeyup=e=>keys[e.key]=false;

/* ================= DATA ================= */
let coins = +localStorage.coins||0;
let owned = JSON.parse(localStorage.owned||"[0]");
let equipped = +localStorage.equipped||0;

/* ================= SHIPS ================= */
const ships=[
{n:"Scout",p:0,draw:(x,y)=>{
  x.beginPath();x.moveTo(x,y-18);x.lineTo(x-12,y+18);x.lineTo(x+12,y+18);x.fill();
}},
{n:"Falcon",p:100,draw:(x,y)=>{
  x.beginPath();x.moveTo(x,y-20);x.lineTo(x-18,y+18);x.lineTo(x,y+8);x.lineTo(x+18,y+18);x.fill();
}},
{n:"Phantom",p:250,draw:(x,y)=>{
  x.beginPath();x.moveTo(x,y-22);x.lineTo(x-16,y+18);x.lineTo(x+16,y+18);x.fill();
  x.fillRect(x-4,y-6,8,16);
}},
{n:"Nova",p:500,draw:(x,y)=>{
  x.beginPath();x.moveTo(x,y-24);x.lineTo(x-20,y+16);x.lineTo(x+20,y+16);x.fill();
  x.fillRect(x-6,y-8,12,20);
}}
];

/* ================= LEVELS ================= */
const levels=[
{name:"ASTEROID DRIFT",d:1},
{name:"NEBULA SWARM",d:2},
{name:"CRIMSON FRONT",d:3},
{name:"VOID ASSAULT",d:4},
{name:"EXTINCTION ZONE",d:5}
];

/* ================= GAME OBJECTS ================= */
let p,enemies=[],pBullets=[],eBullets=[],powerUps=[],stars=[];
let fireDelay=0,level;

/* ================= MENU ================= */
const lvlDiv=document.getElementById("levels");
levels.forEach((l,i)=>{
  let b=document.createElement("button");
  b.className="levelBtn";
  let r=Math.min(255,50+l.d*40);
  b.style.background=`rgb(${r},0,0)`;
  b.textContent=l.name;
  b.onclick=()=>startLevel(i);
  lvlDiv.appendChild(b);
});

/* ================= SHOP ================= */
function openShop(){
  state="SHOP";
  menu.classList.add("hidden");
  shop.classList.remove("hidden");
  drawShop();
}
function closeShop(){
  state="MENU";
  shop.classList.add("hidden");
  menu.classList.remove("hidden");
}
function drawShop(){
  shipsDiv.innerHTML=`<p>Coins: ${coins}</p>`;
  ships.forEach((s,i)=>{
    let b=document.createElement("button");
    if(owned.includes(i)){
      b.textContent=i===equipped?"EQUIPPED":`Equip ${s.n}`;
      b.onclick=()=>{equipped=i;save();}
    }else{
      b.textContent=`Buy ${s.n} (${s.p})`;
      b.onclick=()=>{if(coins>=s.p){coins-=s.p;owned.push(i);save();drawShop();}}
    }
    shipsDiv.appendChild(b);
  });
}
const shipsDiv=document.getElementById("ships");

/* ================= START ================= */
function startLevel(i){
  level=levels[i];
  state="PLAY";
  menu.classList.add("hidden");
  spawn();
  loop();
}
function spawn(){
  p={x:360,y:780,hp:3,shots:1,shield:0};
  enemies=[];pBullets=[];eBullets=[];powerUps=[];
  for(let r=0;r<4+level.d;r++)
    for(let c=0;c<8;c++)
      enemies.push({x:80+c*70,y:80+r*50,hp:1+Math.floor(level.d/2),dx:1+level.d*0.4});
}

/* ================= POWER UPS ================= */
function dropPU(x,y){
  const t=["triple","shield","rapid","pierce","magnet"];
  powerUps.push({x,y,t:t[Math.floor(Math.random()*t.length)],r:0});
}
function applyPU(t){
  if(t=="triple")p.shots=3;
  if(t=="rapid")fireDelay=3;
  if(t=="shield")p.shield=3;
  if(t=="pierce")p.pierce=1;
}

/* ================= LOOP ================= */
function loop(){
  raf=requestAnimationFrame(loop);
  update();draw();
}
function update(){
  if(state!=="PLAY")return;
  if(keys.a)p.x-=6;
  if(keys.d)p.x+=6;
  if(keys.w)p.y-=6;
  if(keys.s)p.y+=6;
  if(keys[" "]&&fireDelay<=0){
    for(let i=0;i<p.shots;i++)
      pBullets.push({x:p.x+i*6-p.shots*3,y:p.y});
    fireDelay=15;
  }
  fireDelay--;
  pBullets.forEach(b=>b.y-=10);
  enemies.forEach(e=>{
    e.x+=e.dx;
    if(Math.random()<0.002*level.d)
      eBullets.push({x:e.x,y:e.y});
  });
  // collisions
  pBullets.forEach((b,bi)=>{
    enemies.forEach((e,ei)=>{
      if(Math.abs(b.x-e.x)<20&&Math.abs(b.y-e.y)<20){
        e.hp--;if(!p.pierce)pBullets.splice(bi,1);
        if(e.hp<=0){
          enemies.splice(ei,1);
          coins+=5;
          if(Math.random()<0.3)dropPU(e.x,e.y);
        }
      }
    });
  });
  powerUps.forEach((u,i)=>{
    u.y+=2;u.r+=0.1;
    if(Math.abs(u.x-p.x)<20&&Math.abs(u.y-p.y)<20){
      applyPU(u.t);powerUps.splice(i,1);
    }
  });
  if(enemies.length==0){save();state="MENU";menu.classList.remove("hidden");cancelAnimationFrame(raf);}
}
function draw(){
  x.clearRect(0,0,720,900);
  if(state!=="PLAY")return;
  x.fillStyle="white";
  ships[equipped].draw(p.x,p.y);
  x.fillStyle="yellow";
  pBullets.forEach(b=>x.fillRect(b.x,b.y,4,10));
  x.fillStyle="red";
  enemies.forEach(e=>x.fillRect(e.x-16,e.y-16,32,32));
  powerUps.forEach(u=>{
    x.save();
    x.translate(u.x,u.y);x.rotate(u.r);
    x.strokeStyle="cyan";x.beginPath();
    x.arc(0,0,10,0,Math.PI*2);x.stroke();
    x.restore();
  });
  x.fillText(`Coins: ${coins}`,10,20);
}
function save(){
  localStorage.coins=coins;
  localStorage.owned=JSON.stringify(owned);
  localStorage.equipped=equipped;
}
</script>
</body>
</html>
